---
phase: 02-core-shader
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/portfolio/fluid-background.tsx
autonomous: true

must_haves:
  truths:
    - "Blobs grandes se movem lentamente no fundo (layer 1 visivel)"
    - "Blobs medios se movem em velocidade media na camada intermediaria"
    - "Blobs pequenos se movem mais rapido na frente"
    - "Cada layer exibe padrao unico (nao sao copias deslocadas)"
    - "Blobs sao sutis com contraste <30% contra background"
  artifacts:
    - path: "components/portfolio/fluid-background.tsx"
      provides: "3-layer domain warping shader"
      contains: "domainWarp"
      exports: ["FluidBackground"]
  key_links:
    - from: "blobLayer function"
      to: "snoise function"
      via: "domain warping pattern"
      pattern: "snoise\\(vec3\\(.*warp"
    - from: "main function"
      to: "blobLayer function"
      via: "three layer calls with distinct params"
      pattern: "blobLayer.*1\\.5.*blobLayer.*2\\.5.*blobLayer.*4\\.0"
---

<objective>
Implement domain warping with 3 distinct blob layers in the FluidBackground shader.

Purpose: Create organic, flowing blob effect with visual depth - large slow blobs in back, medium in middle, small fast blobs in front
Output: Modified fragment shader with domainWarp(), blobLayer(), and 3-layer composition in main()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-shader/02-RESEARCH.md
@components/portfolio/fluid-background.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add domain warping functions and 3-layer composition</name>
  <files>components/portfolio/fluid-background.tsx</files>
  <action>
Modify the fragmentShader string to add domain warping and 3 blob layers.

**Add after snoise() function, before main():**

```glsl
vec2 domainWarp(vec2 p, float scale, float time, vec2 offset) {
  return vec2(
    snoise(vec3(p * scale + offset.x, time)),
    snoise(vec3(p * scale + offset.y, time))
  );
}

float blobLayer(vec2 uv, float scale, float speed, vec2 warpOffset, vec2 noiseOffset, float warpStrength) {
  float time = uTime * speed;
  vec2 warp = domainWarp(uv, scale * 0.5, time * 0.5, warpOffset) * warpStrength;
  vec2 warped = uv * scale + warp + noiseOffset;
  float n = snoise(vec3(warped, time));
  return smoothstep(0.3, 0.7, n * 0.5 + 0.5);
}
```

**Replace entire main() function with:**

```glsl
void main() {
  vec2 uv = gl_FragCoord.xy / uResolution;
  float aspect = uResolution.x / uResolution.y;
  vec2 uvAspect = vec2(uv.x * aspect, uv.y);

  // Layer 1: Large, slow, background
  float layer1 = blobLayer(uvAspect, 1.5, 0.05, vec2(0.0, 0.0), vec2(0.0, 0.0), 0.3);

  // Layer 2: Medium, medium speed
  float layer2 = blobLayer(uvAspect, 2.5, 0.08, vec2(5.2, 1.3), vec2(10.0, 20.0), 0.4);

  // Layer 3: Small, faster, foreground
  float layer3 = blobLayer(uvAspect, 4.0, 0.12, vec2(1.7, 9.2), vec2(30.0, 40.0), 0.5);

  // Colors for subtle effect
  vec3 bgColor = vec3(0.96, 0.96, 0.94);   // #F5F5F0
  vec3 blobColor = vec3(0.90, 0.90, 0.86); // #E5E5DC

  // Composite back-to-front with opacity
  vec3 color = bgColor;
  color = mix(color, blobColor, layer1 * 0.4);  // Large, slow, back
  color = mix(color, blobColor, layer2 * 0.5);  // Medium, middle
  color = mix(color, blobColor, layer3 * 0.6);  // Small, fast, front

  gl_FragColor = vec4(color, 1.0);
}
```

**Layer parameters reference:**
| Layer | Scale | Speed | Warp Offset | Noise Offset | Warp Strength | Opacity |
|-------|-------|-------|-------------|--------------|---------------|---------|
| 1 (back) | 1.5 | 0.05 | (0, 0) | (0, 0) | 0.3 | 0.4 |
| 2 (mid) | 2.5 | 0.08 | (5.2, 1.3) | (10, 20) | 0.4 | 0.5 |
| 3 (front) | 4.0 | 0.12 | (1.7, 9.2) | (30, 40) | 0.5 | 0.6 |

**Why these parameters:**
- Different scales create different blob sizes (1.5 = large, 4.0 = small)
- Different speeds create depth perception (slow = far, fast = near)
- Arbitrary offsets (5.2, 1.3, etc.) sample different noise regions for unique patterns
- Warp strength increases front-to-back for more organic movement on smaller blobs
- Low opacities (0.4-0.6) keep cumulative effect subtle (<30% contrast)
  </action>
  <verify>
1. `bun run build` completes without shader errors
2. Open http://localhost:3000 and observe FluidBackground section
3. Visually confirm: 3 distinct layer speeds (large blobs slow, small blobs faster)
4. Visually confirm: patterns are unique (not displaced copies)
5. Visually confirm: subtle low-contrast effect (blobs dont dominate)
  </verify>
  <done>
- domainWarp() and blobLayer() functions exist in shader
- main() calls blobLayer() 3 times with distinct parameters
- 3 blob layers visible with different scales, speeds, and patterns
- Overall effect is subtle and low-contrast
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>3-layer domain warping blob shader with organic movement</what-built>
  <how-to-verify>
1. Open http://localhost:3000 in browser
2. Scroll to FluidBackground section
3. Observe for 10-15 seconds to see all layer movements

**Check each success criterion:**
- [ ] Layer 1 (large blobs): Move slowly in background - visible with ~0.4 opacity
- [ ] Layer 2 (medium blobs): Move at medium speed - distinct from layer 1
- [ ] Layer 3 (small blobs): Move faster in foreground - most active
- [ ] Patterns unique: Each layer has different shape, not just scaled copies
- [ ] Contrast subtle: Blobs are soft, dont dominate visual attention (<30% contrast)
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 criteria pass, or describe which layer/behavior needs adjustment</resume-signal>
</task>

</tasks>

<verification>
**Code verification:**
- `bun run build` passes (no shader compilation errors)
- fragmentShader contains domainWarp and blobLayer functions
- main() has 3 blobLayer calls with parameters from research

**Visual verification:**
- 3 distinct blob layers visible at different scales
- Movement speeds differ noticeably between layers
- Patterns are unique (verified by observing shapes, not just positions)
- Overall effect is subtle background texture
</verification>

<success_criteria>
1. Build succeeds without shader errors
2. 3 blob layers render with distinct scales (large/medium/small)
3. 3 blob layers move at distinct speeds (slow/medium/fast)
4. Each layer has unique pattern (different noise regions via offsets)
5. Contrast remains subtle (<30% difference from background)
6. Human verification confirms visual quality matches spec
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-shader/02-01-SUMMARY.md`
</output>
