---
phase: 05-mouse-trail-blob
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/portfolio/fluid-background.tsx
autonomous: true

must_haves:
  truths:
    - "Moving the mouse makes a dark blob appear at cursor position"
    - "Mouse blob is darker than background blobs (~25% darker)"
    - "Mouse blob has transparency (~60% max opacity)"
    - "Mouse movement leaves a trail that dissipates gradually"
    - "Trail persists for 2-3 seconds before disappearing completely"
  artifacts:
    - path: "components/portfolio/fluid-background.tsx"
      provides: "Trail buffer uniforms and shader functions"
      contains: "uTrailBuffer"
    - path: "components/portfolio/fluid-background.tsx"
      provides: "getTrailIntensity function in shader"
      contains: "getTrailIntensity"
    - path: "components/portfolio/fluid-background.tsx"
      provides: "smin metaball blending function"
      contains: "smin"
  key_links:
    - from: "pointermove handler"
      to: "trailBuffer array"
      via: "push point with timestamp"
      pattern: "trailBuffer\\.push"
    - from: "animate loop"
      to: "uniforms.uTrailBuffer"
      via: "sync buffer to GPU"
      pattern: "uniforms\\.uTrailBuffer"
    - from: "getTrailIntensity()"
      to: "uTrailBuffer uniform"
      via: "loop over trail points"
      pattern: "for.*uTrailBuffer"
    - from: "main()"
      to: "dark color mix"
      via: "mix with trail intensity"
      pattern: "mix.*trailIntensity"
---

<objective>
Implement mouse trail blob effect with darker semi-transparent blob following mouse cursor and leaving visible trail

Purpose: Create the landonorris.com-style trail effect where mouse movement leaves a visible darker trace over the topographic background
Output: Working trail blob that follows mouse with gradual dissipation over 2-3 seconds
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mouse-trail-blob/05-RESEARCH.md
@components/portfolio/fluid-background.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trail buffer infrastructure</name>
  <files>components/portfolio/fluid-background.tsx</files>
  <action>
Add trail buffer system to FluidBackground component:

1. Add new uniforms after existing ones:
```typescript
const uniforms = {
  // ... existing uniforms ...
  uTrailBuffer: { value: new Array(16).fill(null).map(() => new THREE.Vector3(-1, -1, 0)) },
  uTrailCount: { value: 0 },
  uTrailDecay: { value: 2.5 },
}
```

2. Add trail buffer array and quality detection BEFORE animate function:
```typescript
const trailBuffer: Array<{ x: number; y: number; time: number }> = []
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
const MAX_TRAIL_POINTS = isMobile ? 10 : 16
```

3. Update handlePointerMove to add trail points:
```typescript
function handlePointerMove(event: PointerEvent) {
  if (!container) return
  const rect = container.getBoundingClientRect()
  const x = (event.clientX - rect.left) / rect.width
  const y = 1.0 - (event.clientY - rect.top) / rect.height
  const currentTime = (performance.now() - startTime) * 0.001

  trailBuffer.push({ x, y, time: currentTime })

  if (trailBuffer.length > MAX_TRAIL_POINTS) {
    trailBuffer.shift()
  }

  targetMouse.set(x, y)
}
```

4. Update animate() to sync trail buffer to uniforms and cull expired points:
```typescript
function animate() {
  if (contextLost) return
  const currentTime = (performance.now() - startTime) * 0.001
  uniforms.uTime.value = currentTime

  // Cull expired trail points
  const decayTime = uniforms.uTrailDecay.value
  let i = 0
  while (i < trailBuffer.length) {
    if (currentTime - trailBuffer[i].time > decayTime) {
      trailBuffer.splice(i, 1)
    } else {
      i++
    }
  }

  // Sync trail buffer to uniforms
  for (let j = 0; j < 16; j++) {
    if (j < trailBuffer.length) {
      const point = trailBuffer[j]
      uniforms.uTrailBuffer.value[j].set(point.x, point.y, point.time)
    } else {
      uniforms.uTrailBuffer.value[j].set(-1, -1, 0)
    }
  }
  uniforms.uTrailCount.value = trailBuffer.length

  currentMouse.lerp(targetMouse, 0.1)
  uniforms.uMouse.value.copy(currentMouse)
  renderer.render(scene, camera)
  animationId = requestAnimationFrame(animate)
}
```

Note: Use splice for culling (simple and performant for small arrays). The sync loop runs every frame but only updates 16 vec3 uniforms which is negligible overhead.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
bun run build
```
Check uniforms are declared:
```bash
grep -E "uTrailBuffer|uTrailCount|uTrailDecay" components/portfolio/fluid-background.tsx
```
  </verify>
  <done>
Trail buffer uniforms declared and synced each frame. Trail points added on pointermove. Expired points culled based on uTrailDecay. Adaptive point count for mobile (10) vs desktop (16).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement shader trail blob rendering</name>
  <files>components/portfolio/fluid-background.tsx</files>
  <action>
Add trail blob rendering to fragment shader:

1. Add new uniform declarations after existing ones (line ~32):
```glsl
uniform vec3 uTrailBuffer[16];
uniform int uTrailCount;
uniform float uTrailDecay;
```

2. Add smin function after taylorInvSqrt (for metaball blending):
```glsl
float smin(float a, float b, float k) {
  float h = max(k - abs(a - b), 0.0) / k;
  return min(a, b) - h * h * k * 0.25;
}
```

3. Add getTrailIntensity function before main():
```glsl
float getTrailIntensity(vec2 uv) {
  if (uTrailCount == 0) return 0.0;

  float intensity = 0.0;
  float aspect = uResolution.x / uResolution.y;
  vec2 uvAspect = vec2(uv.x * aspect, uv.y);

  for (int i = 0; i < 16; i++) {
    if (i >= uTrailCount) break;

    vec3 tp = uTrailBuffer[i];
    if (tp.x < 0.0) continue;

    vec2 trailPos = vec2(tp.x * aspect, tp.y);
    float dist = distance(uvAspect, trailPos);

    if (dist > 0.2) continue;

    float age = uTime - tp.z;
    float fade = exp(-age / uTrailDecay * 2.0);

    if (fade < 0.01) continue;

    float blob = smoothstep(0.12, 0.0, dist) * fade;
    intensity = max(intensity, blob);
  }

  return clamp(intensity, 0.0, 1.0);
}
```

4. Update main() to apply trail blob BEFORE isolines (insert after line 147 "vec3 color = bgColor;"):
```glsl
// Apply trail blob (darker overlay)
float trailIntensity = getTrailIntensity(uv);
if (trailIntensity > 0.01) {
  vec3 darkColor = bgColor * 0.75;
  color = mix(color, darkColor, trailIntensity * 0.6);
}

// Draw isolines (existing code continues after)
```

The trail applies BEFORE isolines so that isolines remain visible on top of the dark trail. Using max() instead of smin() for intensity accumulation (simpler, sufficient for this effect). Blob radius 0.12 gives good size. Fade uses exponential decay with smooth cutoff at 0.01.
  </action>
  <verify>
Build passes:
```bash
bun run build
```
Shader functions present:
```bash
grep -E "smin|getTrailIntensity|uTrailBuffer\[16\]" components/portfolio/fluid-background.tsx
```
Manual verification at localhost:3000 - move mouse and observe:
- Dark blob follows cursor
- Trail persists and fades over ~2-3 seconds
- Isolines remain visible on top of trail
  </verify>
  <done>
Shader renders trail blob as darker semi-transparent overlay. Trail follows mouse with exponential decay. Blob is 25% darker than background with 60% max opacity. Isolines remain visible above trail.
  </done>
</task>

</tasks>

<verification>
1. Build verification:
```bash
bun run build
```

2. Code verification:
```bash
grep -c "uTrailBuffer" components/portfolio/fluid-background.tsx
# Should return 4+ (declaration, uniform, sync loop, shader)
```

3. Visual verification at localhost:3000:
- [ ] Dark blob appears at mouse position
- [ ] Blob color is visibly darker than background
- [ ] Trail persists when moving mouse quickly
- [ ] Trail fades gradually over 2-3 seconds
- [ ] Isolines remain visible above trail
- [ ] No performance degradation during mouse movement
</verification>

<success_criteria>
- Build passes without errors
- Moving mouse shows dark blob at cursor position
- Mouse movement leaves visible trail
- Trail dissipates over 2-3 seconds with smooth fade
- Blob is darker (25%) and semi-transparent (60% max)
- Isolines remain visible on top of trail
- 60fps maintained on desktop, acceptable on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/05-mouse-trail-blob/05-01-SUMMARY.md`
</output>
